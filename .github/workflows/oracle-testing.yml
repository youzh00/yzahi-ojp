# This workflow runs Oracle Database tests autonomously without requiring Oracle JDBC drivers in the repository.
# It dynamically adds the Oracle JDBC driver during CI execution and runs Oracle-specific tests.
name: Oracle Database Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  oracle-test:
    name: Oracle Tests (JDK ${{ matrix.java-version }})
    runs-on: ubuntu-latest
    
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        java-version: [ 11, 17, 21, 22 ]

    services:
      oracle:
        image: gvenzl/oracle-xe:21-full
        env:
          ORACLE_PASSWORD: testpassword
          APP_USER: testuser
          APP_USER_PASSWORD: testpassword
        options: >-
          --name ojp-oracle
          --health-cmd "echo 'SELECT 1 FROM DUAL;' | sqlplus -s system/testpassword@localhost/XEPDB1"
          --health-interval 20s
          --health-timeout 10s
          --health-retries 10
        ports:
          - 1521:1521

    steps:

      - name: Git checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Grant XA permissions to Oracle test user
        run: |
          # Wait a bit for Oracle to be fully ready
          sleep 5
          
          # Grant XA permissions to testuser
          echo "=== Granting XA permissions to testuser ==="
          
          docker exec ojp-oracle sqlplus -s system/testpassword@localhost/XEPDB1 <<'EOF'
          SET ECHO ON
          SET FEEDBACK ON
          SET SERVEROUTPUT ON
          WHENEVER SQLERROR EXIT SQL.SQLCODE
          
          -- Grant XA_RECOVER_ADMIN role (Oracle 12c+) for XA transaction recovery
          -- This role includes necessary privileges for XA operations
          GRANT XA_RECOVER_ADMIN TO testuser;
          
          -- XA transaction permissions (additional grants for completeness)
          GRANT SELECT ON sys.dba_pending_transactions TO testuser;
          GRANT SELECT ON sys.pending_trans$ TO testuser;
          GRANT SELECT ON sys.dba_2pc_pending TO testuser;
          GRANT SELECT ON sys.dba_2pc_neighbors TO testuser;
          GRANT EXECUTE ON sys.dbms_xa TO testuser;
          GRANT EXECUTE ON sys.dbms_system TO testuser;
          GRANT FORCE ANY TRANSACTION TO testuser;
          
          -- Verify grants
          SELECT 'XA permissions granted successfully' AS status FROM dual;
          
          -- Show granted privileges and roles
          SELECT granted_role, grantee FROM dba_role_privs WHERE grantee = 'TESTUSER' ORDER BY granted_role;
          SELECT privilege, grantee FROM dba_sys_privs WHERE grantee = 'TESTUSER' ORDER BY privilege;
          SELECT owner, table_name, privilege, grantee FROM dba_tab_privs WHERE grantee = 'TESTUSER' ORDER BY owner, table_name;
          
          EXIT;
          EOF
          
          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to grant XA permissions!"
            exit 1
          fi
          
          echo "=== XA permissions granted successfully ==="

      - name: Add Oracle JDBC Driver to ojp-server
        run: |
          # Create temporary file with Oracle JDBC dependency
          cat > /tmp/oracle-dep.txt << 'EOF'
          <!-- Oracle JDBC Driver (added by CI) -->
          <dependency>
              <groupId>com.oracle.database.jdbc</groupId>
              <artifactId>ojdbc11</artifactId>
              <version>23.8.0.25.04</version>
          </dependency>
          EOF
          
          # Insert after the placeholder comment
          sed -i '/<!-- PROPRIETARY DATABASE DRIVERS PLACEHOLDER -->/r /tmp/oracle-dep.txt' ojp-server/pom.xml
          
          # Verify the insertion
          echo "=== Modified ojp-server/pom.xml dependencies section ==="
          sed -n '/PROPRIETARY DATABASE DRIVERS PLACEHOLDER/,/HikariCP/p' ojp-server/pom.xml

      - name: Set up JDK 22 for build
        uses: actions/setup-java@v4
        with:
          java-version: 22
          distribution: 'temurin'
          cache: maven

      - name: Build and Install (ojp-grpc-commons) with JDK 22
        run: mvn clean install -pl ojp-grpc-commons -am -DskipTests -Dgpg.skip=true

      - name: Test (ojp-grpc-commons) with JDK 22
        run: mvn test -pl ojp-grpc-commons -Dgpg.skip=true

      - name: Build (ojp-server) with JDK 22
        run: mvn clean install -pl ojp-server -am -DskipTests -Dgpg.skip=true

      - name: Test and Run (ojp-server)
        run: |
          nohup java -jar ojp-server/target/ojp-server-0.2.1-snapshot-shaded.jar > /tmp/ojp-server.log 2>&1 &
          echo $! > /tmp/ojp-server.pid

      - name: Wait for ojp-server to start
        run: sleep 10

      - name: Set up JDK ${{ matrix.java-version }} for ojp-jdbc-driver
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: maven

      - name: Build (ojp-jdbc-driver) with JDK ${{ matrix.java-version }}
        run: mvn clean install -pl ojp-jdbc-driver -am -DskipTests -Dgpg.skip=true

      - name: Test (ojp-jdbc-driver) with Oracle enabled
        run: mvn test -pl ojp-jdbc-driver -Dgpg.skip=true -DenableOracleTests -DdisablePostgresTests -DdisableMySQLTests -DdisableMariaDBTests -DdisableCockroachDBTests

      - name: Show ojp-server.log
        if: always()  # ensures it runs even if previous steps fail
        run: cat /tmp/ojp-server.log || echo "/tmp/ojp-server.log not found"

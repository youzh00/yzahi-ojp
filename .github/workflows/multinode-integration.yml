# This workflow tests multinode functionality with two OJP server instances
# It starts a Postgres database and two OJP servers on different ports,
# then runs integration tests for multinode scenarios including failover and recovery.
# On main branch: runs only after Main CI workflow completes successfully.
# On PRs: runs in parallel with Main CI.
name: Multinode Integration Tests

on:
  pull_request:
    branches: [ main ]
  workflow_run:
    workflows: ["Main CI"]
    types:
      - completed
    branches: [ main ]

jobs:
  multinode-test:
    name: Multinode Integration Test
    runs-on: ubuntu-latest
    # For workflow_run events, only run if Main CI succeeded
    # For pull_request events, always run
    if: ${{ github.event_name == 'pull_request' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Git checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Start Postgres
        run: |
          docker run --name ojp-postgres-multinode \
            -e POSTGRES_USER=testuser \
            -e POSTGRES_PASSWORD=testpassword \
            -e POSTGRES_DB=defaultdb \
            -p 5432:5432 \
            -d postgres:17 \
            -c max_prepared_transactions=100
      
          # Wait for Postgres to become ready (up to 60s)
          timeout 60 bash -c 'until docker exec ojp-postgres-multinode pg_isready -U testuser -d defaultdb -h 127.0.0.1; do sleep 2; done'

          # Verify setting
          PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -c "SHOW max_prepared_transactions;"

      - name: Set up JDK 22 for build
        uses: actions/setup-java@v4
        with:
          java-version: 22
          distribution: 'temurin'
          cache: maven

      - name: Build and Install (ojp-grpc-commons) with JDK 22
        run: mvn clean install -pl ojp-grpc-commons -am -DskipTests -Dgpg.skip=true

      - name: Test (ojp-grpc-commons) with JDK 22
        run: mvn test -pl ojp-grpc-commons -Dgpg.skip=true

      - name: Build (ojp-server) with JDK 22
        run: mvn clean install -pl ojp-server -am -DskipTests -Dgpg.skip=true

      - name: Start OJP Server 1 on port 10591
        run: |
          # Start first server on port 10591 with Prometheus on 9159
          nohup java -Dojp.server.port=10591 -Dojp.prometheus.port=9159 -jar ojp-server/target/ojp-server-0.2.1-snapshot-shaded.jar > /tmp/ojp-server-1.log 2>&1 &
          echo $! > /tmp/ojp-server-1.pid
          echo "Started OJP Server 1 on gRPC port 10591, Prometheus port 9159 with PID $(cat /tmp/ojp-server-1.pid)"

      - name: Start OJP Server 2 on port 10592
        run: |
          # Start second server on port 10592 with Prometheus on 9160
          nohup java -Dojp.server.port=10592 -Dojp.prometheus.port=9160 -jar ojp-server/target/ojp-server-0.2.1-snapshot-shaded.jar > /tmp/ojp-server-2.log 2>&1 &
          echo $! > /tmp/ojp-server-2.pid
          echo "Started OJP Server 2 on gRPC port 10592, Prometheus port 9160 with PID $(cat /tmp/ojp-server-2.pid)"

      - name: Wait for OJP servers to start
        run: |
          echo "Waiting for servers to start..."
          sleep 15
          echo "Checking if servers are listening..."
          netstat -tuln | grep -E ':(10591|10592)' || echo "Warning: Servers might not be listening yet"

      - name: Build (ojp-jdbc-driver) with JDK 22
        run: mvn clean install -pl ojp-jdbc-driver -am -DskipTests -Dgpg.skip=true

      - name: Create temp directory for test logs
        run: mkdir -p temp

      - name: Start MultinodeIntegrationTest with nohup
        run: |
          echo "Starting MultinodeIntegrationTest in background..."
          nohup mvn test -pl ojp-jdbc-driver -Dtest=MultinodeIntegrationTest -DmultinodeTestsEnabled=true -Dgpg.skip=true > temp/MultinodeIntegrationTest.log 2>&1 &
          echo $! > temp/multinode-test.pid
          echo "MultinodeIntegrationTest started with PID $(cat temp/multinode-test.pid)"
          # Give test time to start
          sleep 20

      - name: Check PostgreSQL connections during test
        run: |
          echo "Checking PostgreSQL connections..."
          TIMEOUT=60
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            CONNECTION_COUNT=$(PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -t -c "SELECT COUNT(*) FROM pg_stat_activity WHERE datname='defaultdb';")
            CONNECTION_COUNT=$(echo $CONNECTION_COUNT | tr -d '[:space:]')
            echo "Current connections: $CONNECTION_COUNT (elapsed: ${ELAPSED}s)"
            
            if [ "$CONNECTION_COUNT" -ge 20 ] && [ "$CONNECTION_COUNT" -lt 25 ]; then
              echo "✓ Connection count is within expected range: 20 ≤ $CONNECTION_COUNT < 25"
              PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -c "SELECT datname, COUNT(*) AS connections FROM pg_stat_activity WHERE datname='defaultdb' GROUP BY datname ORDER BY connections DESC;"
              break
            elif [ "$CONNECTION_COUNT" -ge 25 ]; then
              echo "✗ ERROR: Connection count ($CONNECTION_COUNT) exceeds maximum of 25!"
              PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -c "SELECT datname, COUNT(*) AS connections FROM pg_stat_activity WHERE datname='defaultdb' GROUP BY datname ORDER BY connections DESC;"
              exit 1
            else
              echo "Waiting for connections to reach at least 20... (currently: $CONNECTION_COUNT)"
              sleep 2
              ELAPSED=$((ELAPSED + 2))
            fi
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "✗ ERROR: Timeout after ${TIMEOUT}s - connection count never reached 20 (current: $CONNECTION_COUNT)"
            exit 1
          fi

      - name: Kill OJP Server 1
        run: |
          echo "Killing OJP Server 1..."
          if [ -f /tmp/ojp-server-1.pid ]; then
            kill $(cat /tmp/ojp-server-1.pid) || true
            echo "OJP Server 1 killed"
          fi
          sleep 10

      - name: Check PostgreSQL connections after killing Server 1
        run: |
          echo "Checking PostgreSQL connections after killing Server 1..."
          TIMEOUT=60
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            CONNECTION_COUNT=$(PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -t -c "SELECT COUNT(*) FROM pg_stat_activity WHERE datname='defaultdb';")
            CONNECTION_COUNT=$(echo $CONNECTION_COUNT | tr -d '[:space:]')
            echo "Current connections: $CONNECTION_COUNT (elapsed: ${ELAPSED}s)"
            
            if [ "$CONNECTION_COUNT" -ge 20 ] && [ "$CONNECTION_COUNT" -lt 25 ]; then
              echo "✓ Connection count is within expected range: 20 ≤ $CONNECTION_COUNT < 25"
              PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -c "SELECT datname, COUNT(*) AS connections FROM pg_stat_activity WHERE datname='defaultdb' GROUP BY datname ORDER BY connections DESC;"
              break
            elif [ "$CONNECTION_COUNT" -ge 25 ]; then
              echo "✗ ERROR: Connection count ($CONNECTION_COUNT) exceeds maximum of 25!"
              PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -c "SELECT datname, COUNT(*) AS connections FROM pg_stat_activity WHERE datname='defaultdb' GROUP BY datname ORDER BY connections DESC;"
              exit 1
            else
              echo "Waiting for connections to reach at least 20... (currently: $CONNECTION_COUNT)"
              sleep 2
              ELAPSED=$((ELAPSED + 2))
            fi
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "✗ ERROR: Timeout after ${TIMEOUT}s - connection count never reached 20 (current: $CONNECTION_COUNT)"
            exit 1
          fi

      - name: Restart OJP Server 1
        run: |
          echo "Restarting OJP Server 1..."
          nohup java -Dojp.server.port=10591 -Dojp.prometheus.port=9159 -jar ojp-server/target/ojp-server-0.2.1-snapshot-shaded.jar > /tmp/ojp-server-1-restart.log 2>&1 &
          echo $! > /tmp/ojp-server-1-restart.pid
          echo "OJP Server 1 restarted with PID $(cat /tmp/ojp-server-1-restart.pid)"
          sleep 10

      - name: Check PostgreSQL connections after restarting Server 1
        run: |
          echo "Checking PostgreSQL connections after restarting Server 1..."
          TIMEOUT=60
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            CONNECTION_COUNT=$(PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -t -c "SELECT COUNT(*) FROM pg_stat_activity WHERE datname='defaultdb';")
            CONNECTION_COUNT=$(echo $CONNECTION_COUNT | tr -d '[:space:]')
            echo "Current connections: $CONNECTION_COUNT (elapsed: ${ELAPSED}s)"
            
            if [ "$CONNECTION_COUNT" -ge 20 ] && [ "$CONNECTION_COUNT" -lt 25 ]; then
              echo "✓ Connection count is within expected range: 20 ≤ $CONNECTION_COUNT < 25"
              PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -c "SELECT datname, COUNT(*) AS connections FROM pg_stat_activity WHERE datname='defaultdb' GROUP BY datname ORDER BY connections DESC;"
              break
            elif [ "$CONNECTION_COUNT" -ge 25 ]; then
              echo "✗ ERROR: Connection count ($CONNECTION_COUNT) exceeds maximum of 25!"
              PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -c "SELECT datname, COUNT(*) AS connections FROM pg_stat_activity WHERE datname='defaultdb' GROUP BY datname ORDER BY connections DESC;"
              exit 1
            else
              echo "Waiting for connections to reach at least 20... (currently: $CONNECTION_COUNT)"
              sleep 2
              ELAPSED=$((ELAPSED + 2))
            fi
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "✗ ERROR: Timeout after ${TIMEOUT}s - connection count never reached 20 (current: $CONNECTION_COUNT)"
            exit 1
          fi

      - name: Kill OJP Server 2
        run: |
          echo "Killing OJP Server 2..."
          if [ -f /tmp/ojp-server-2.pid ]; then
            kill $(cat /tmp/ojp-server-2.pid) || true
            echo "OJP Server 2 killed"
          fi
          sleep 10

      - name: Check PostgreSQL connections after killing Server 2
        run: |
          echo "Checking PostgreSQL connections after killing Server 2..."
          TIMEOUT=60
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            CONNECTION_COUNT=$(PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -t -c "SELECT COUNT(*) FROM pg_stat_activity WHERE datname='defaultdb';")
            CONNECTION_COUNT=$(echo $CONNECTION_COUNT | tr -d '[:space:]')
            echo "Current connections: $CONNECTION_COUNT (elapsed: ${ELAPSED}s)"
            
            if [ "$CONNECTION_COUNT" -ge 20 ] && [ "$CONNECTION_COUNT" -lt 25 ]; then
              echo "✓ Connection count is within expected range: 20 ≤ $CONNECTION_COUNT < 25"
              PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -c "SELECT datname, COUNT(*) AS connections FROM pg_stat_activity WHERE datname='defaultdb' GROUP BY datname ORDER BY connections DESC;"
              break
            elif [ "$CONNECTION_COUNT" -ge 25 ]; then
              echo "✗ ERROR: Connection count ($CONNECTION_COUNT) exceeds maximum of 25!"
              PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -c "SELECT datname, COUNT(*) AS connections FROM pg_stat_activity WHERE datname='defaultdb' GROUP BY datname ORDER BY connections DESC;"
              exit 1
            else
              echo "Waiting for connections to reach at least 20... (currently: $CONNECTION_COUNT)"
              sleep 2
              ELAPSED=$((ELAPSED + 2))
            fi
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "✗ ERROR: Timeout after ${TIMEOUT}s - connection count never reached 20 (current: $CONNECTION_COUNT)"
            exit 1
          fi

      - name: Restart OJP Server 2
        run: |
          echo "Restarting OJP Server 2..."
          nohup java -Dojp.server.port=10592 -Dojp.prometheus.port=9160 -jar ojp-server/target/ojp-server-0.2.1-snapshot-shaded.jar > /tmp/ojp-server-2-restart.log 2>&1 &
          echo $! > /tmp/ojp-server-2-restart.pid
          echo "OJP Server 2 restarted with PID $(cat /tmp/ojp-server-2-restart.pid)"
          sleep 10

      - name: Check PostgreSQL connections after restarting Server 2
        run: |
          echo "Checking PostgreSQL connections after restarting Server 2..."
          TIMEOUT=60
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            CONNECTION_COUNT=$(PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -t -c "SELECT COUNT(*) FROM pg_stat_activity WHERE datname='defaultdb';")
            CONNECTION_COUNT=$(echo $CONNECTION_COUNT | tr -d '[:space:]')
            echo "Current connections: $CONNECTION_COUNT (elapsed: ${ELAPSED}s)"
            
            if [ "$CONNECTION_COUNT" -ge 20 ] && [ "$CONNECTION_COUNT" -lt 25 ]; then
              echo "✓ Connection count is within expected range: 20 ≤ $CONNECTION_COUNT < 25"
              PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -c "SELECT datname, COUNT(*) AS connections FROM pg_stat_activity WHERE datname='defaultdb' GROUP BY datname ORDER BY connections DESC;"
              break
            elif [ "$CONNECTION_COUNT" -ge 25 ]; then
              echo "✗ ERROR: Connection count ($CONNECTION_COUNT) exceeds maximum of 25!"
              PGPASSWORD=testpassword psql -h 127.0.0.1 -U testuser -d defaultdb -c "SELECT datname, COUNT(*) AS connections FROM pg_stat_activity WHERE datname='defaultdb' GROUP BY datname ORDER BY connections DESC;"
              exit 1
            else
              echo "Waiting for connections to reach at least 20... (currently: $CONNECTION_COUNT)"
              sleep 2
              ELAPSED=$((ELAPSED + 2))
            fi
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "✗ ERROR: Timeout after ${TIMEOUT}s - connection count never reached 20 (current: $CONNECTION_COUNT)"
            exit 1
          fi

      - name: Wait for MultinodeIntegrationTest to complete
        run: |
          echo "Waiting for MultinodeIntegrationTest to complete..."
          # Wait for test process to finish (max 10 minutes)
          if [ -f temp/multinode-test.pid ]; then
            TEST_PID=$(cat temp/multinode-test.pid)
            TIMEOUT=60
            ELAPSED=0
            while kill -0 $TEST_PID 2>/dev/null && [ $ELAPSED -lt $TIMEOUT ]; do
              echo "Test still running... (${ELAPSED}s elapsed)"
              sleep 10
              ELAPSED=$((ELAPSED + 10))
            done
            
            if kill -0 $TEST_PID 2>/dev/null; then
              echo "Test did not complete within timeout, terminating..."
              kill $TEST_PID || true
            else
              echo "Test completed successfully"
            fi
          fi

      - name: Verify test results
        run: |
          echo "Checking MultinodeIntegrationTest results..."
          if grep -q "BUILD SUCCESS" temp/MultinodeIntegrationTest.log; then
            echo "✓ Test passed successfully"
          elif grep -q "BUILD FAILURE" temp/MultinodeIntegrationTest.log; then
            echo "✗ Test failed"
            exit 1
          else
            echo "⚠ Could not determine test status"
          fi

      - name: Show OJP Server 1 log
        if: always()
        run: |
          echo "=== OJP Server 1 Initial Log ==="
          cat /tmp/ojp-server-1.log || echo "/tmp/ojp-server-1.log not found"
          echo ""
          echo "=== OJP Server 1 Restart Log ==="
          cat /tmp/ojp-server-1-restart.log || echo "/tmp/ojp-server-1-restart.log not found"

      - name: Show OJP Server 2 log
        if: always()
        run: |
          echo "=== OJP Server 2 Initial Log ==="
          cat /tmp/ojp-server-2.log || echo "/tmp/ojp-server-2.log not found"
          echo ""
          echo "=== OJP Server 2 Restart Log ==="
          cat /tmp/ojp-server-2-restart.log || echo "/tmp/ojp-server-2-restart.log not found"

      - name: Show MultinodeIntegrationTest log
        if: always()
        run: |
          echo "=== MultinodeIntegrationTest Log ==="
          cat temp/MultinodeIntegrationTest.log || echo "temp/MultinodeIntegrationTest.log not found"

      - name: Cleanup
        if: always()
        run: |
          # Kill any remaining OJP server processes
          pkill -f "ojp-server-0.2.1-snapshot-shaded.jar" || true
          # Stop Postgres container
          docker stop ojp-postgres-multinode || true
          docker rm ojp-postgres-multinode || true
